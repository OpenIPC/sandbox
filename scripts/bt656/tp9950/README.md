# Переключение режимов AHD/TVI/CVI/CVBS  на видеосервере с TP9950


### `setType9950.sh`     
скрипт инициализирующий указанный режим TP9950 по i2c  
>Usage: /usr/sbin/setType9950.sh  
>ahd_1920x1080_25fps   
>ahd_1920x1080_30fps  
>cvi_1920x1080_25fps  
>cvi_1920x1080_30fps  
>tvi_1920x1080_25fps  
>tvi_1920x1080_30fps  
>ahd_1280x720_25fps  
>ahd_1280x720_30fps  
>cvi_1280x720_25fps  
>cvi_1280x720_30fps  
>tvi_1280x720_25fps  
>tvi_1280x720_30fps  
>pal_960x288_25fps  
>ntsc_960x240_30fps
>
```function send_same() ``` - заполнение значений регистров одинаковых для всех типов и разрешений     
____

### `test_type.sh`   
скрипт теста типа видеосигнала. В цикле проверяются флаги статус регистров TP9950, на наличие видеосигнала, разрешение и частота кадров и детектор цветовой поднесущей.  
`sensorConfig='/etc/sensors/bt656_720p.ini'` имя конфиг файла. Использутся существующий в поставке, требуется для смены разрешения видео.  
`ipctool gpio mux 69 gpio` инициализация штвтного светодиода. Включается при успешном детектировании формата видео.
`function changeINI` функция смены разрешения   
```[ $(((`ipctool2 i2cget 0x88 0x01` >> 7) & 0x1)) -eq 1 ] ``` старший бит регистра 0x01 - "1" - нет сигнала, "0" - есть сигнал.  
```$((`ipctool2 i2cget 0x88 0x03` & 0x7))```  три младших бита - разрешение и частота кадров видеосигнала  

>**0** 1280x720_60fps    
>**1** 1280x720_50fps  
>**2** 1920x1080_30fps  
>**3** 1920x1080_25fps  
>**4** 1280x720_30fps  
>**5** 1280x720_25fps  
>**6** cvbs  
>**7** other (сюда же попал TVI 720p на всех имеющихся образцах, зависит от делителей и тактовой частоты TP9950)

в case  перебор типов AHD/TVI/CVI  - различия в количестве пикселей в строке, отступе синхронизаций и цветовой поднесущей от начала строки. Нужно попробовать, проверить флаги `Carrier PLL lock` и `Carrier detect`  - детект цвета и либо оставить тип либо следующий.  
```[ $((($status >> 4) & 0x1)) -ne 1 ]  || [ $((($status ) & 0x1)) -ne 0 ]```  - проверка `Carrier PLL lock` и `Carrier detect` 
```fw_setenv TP9950type $fmt``` сохранение в env выбранного типа `pal/ntsc/ahd/cvi/tvi`  
```fw_setenv TP9950res ```  сохранение в env выбранного разрешения
При детектировании нового разрешения - меняются параметры .ini и перезапускается majestic.      


______
### `setup.sh`     
скрипт восстановления инита tp9950 после запуска majestic и инита libsns_bt656.so  
```killall test_type.sh``` прибить `test_type.sh` для монопольного доступа к i2c   
```test_type.sh & ``` так же является первым запуском скрипта детекции для автоматического режима работы.     

_____
т.к. не решен вопрос с `Scanmode = VI_SCAN_INTERLACED` CVBS принимается в разрешениях 960x288 и 960x240. Тряска от черезстрочной развертки вызывает сработку MD - нужен фильтр.  
